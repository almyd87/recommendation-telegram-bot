
import requests
import time
from bs4 import BeautifulSoup
from datetime import datetime

def get_analysis():
    return "Strong Sell"  # Ù…Ø­Ø§ÙƒØ§Ø© ÙÙ‚Ø·

def get_indicator_details():
    url = "https://www.investing.com/currencies/eur-usd-technical"
    headers = {"User-Agent": "Mozilla/5.0"}
    indicators = {
        "EMA20": None,
        "EMA50": None,
        "RSI(14)": None,
        "Bollinger Bands": None,
        "Trend": None
    }
    try:
        r = requests.get(url, headers=headers)
        soup = BeautifulSoup(r.text, "html.parser")
        table = soup.find("table", class_="technicalIndicatorsTbl")
        rows = table.find_all("tr")[1:]
        for row in rows:
            cols = row.find_all("td")
            if len(cols) >= 3:
                name = cols[0].text.strip()
                value = cols[1].text.strip()
                signal = cols[2].text.strip()
                if name in indicators:
                    indicators[name] = {"value": value, "signal": signal}
    except Exception as e:
        print("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª:", e)
    return indicators

def explain_indicator(name, value, signal):
    try:
        val = float(value)
    except:
        return "ğŸ” Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ³ÙŠØ± Ø§Ù„Ù‚ÙŠÙ…Ø©."
    if "EMA" in name:
        if signal == "Buy":
            return "ğŸ” Ø§Ù„Ø³Ø¹Ø± Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø· â†’ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ØµØ§Ø¹Ø¯ âœ…"
        elif signal == "Sell":
            return "ğŸ” Ø§Ù„Ø³Ø¹Ø± Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø· â†’ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù‡Ø§Ø¨Ø· ğŸ”»"
        else:
            return "ğŸ” Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù…ØªÙˆØ³Ø· â†’ Ø³ÙˆÙ‚ ØºÙŠØ± ÙˆØ§Ø¶Ø­ â³"
    if "RSI" in name:
        if val < 30:
            return "ğŸ” RSI Ù…Ù†Ø®ÙØ¶ â†’ ØªØ´Ø¨Ù‘Ø¹ Ø¨ÙŠØ¹ÙŠ â†’ Ø§Ø­ØªÙ…Ø§Ù„ ØµØ¹ÙˆØ¯ ğŸ”¼"
        elif val > 70:
            return "ğŸ” RSI Ù…Ø±ØªÙØ¹ â†’ ØªØ´Ø¨Ù‘Ø¹ Ø´Ø±Ø§Ø¦ÙŠ â†’ Ø§Ø­ØªÙ…Ø§Ù„ Ù‡Ø¨ÙˆØ· ğŸ”½"
        else:
            return "ğŸ” RSI Ø·Ø¨ÙŠØ¹ÙŠ â†’ Ù„Ø§ Ø¶ØºØ· Ø­Ø§Ù„ÙŠØ§Ù‹ ğŸ”"
    if "Bollinger" in name:
        if signal == "Buy":
            return "ğŸ” Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø³ÙÙ„ÙŠ â†’ Ø§Ø±ØªØ¯Ø§Ø¯ ØµØ¹ÙˆØ¯ÙŠ Ù…Ø­ØªÙ…Ù„ ğŸ”¼"
        elif signal == "Sell":
            return "ğŸ” Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø¹Ù„ÙˆÙŠ â†’ Ø¶ØºØ· Ø¨ÙŠØ¹ÙŠ ğŸ”½"
        else:
            return "ğŸ” Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ â†’ Ù„Ø§ Ø¶ØºØ· Ø­Ø§Ù„ÙŠ ğŸ”"
    return "ğŸ” Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙØ³ÙŠØ±."

def explain_trend(signal):
    if signal == "Buy":
        return "ğŸ” Ø§Ù„Ø³ÙˆÙ‚ ÙÙŠ Ø§ØªØ¬Ø§Ù‡ ØµØ§Ø¹Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ âœ…"
    elif signal == "Sell":
        return "ğŸ” Ø§Ù„Ø³ÙˆÙ‚ ÙÙŠ Ø§ØªØ¬Ø§Ù‡ Ù‡Ø§Ø¨Ø· Ø­Ø§Ù„ÙŠØ§Ù‹ ğŸ”»"
    elif signal == "Neutral":
        return "ğŸ” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØ¬Ø§Ù‡ ÙˆØ§Ø¶Ø­ (Ø³ÙˆÙ‚ Ù…ØªØ°Ø¨Ø°Ø¨) â³"
    return "ğŸ” Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ³ÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡"

def get_recommendation_message(signal, indicators):
    emoji_map = {
        "Buy": "ğŸŸ¢", "Strong Buy": "ğŸŸ¢",
        "Sell": "ğŸ”´", "Strong Sell": "ğŸ”´",
        "Neutral": "ğŸŸ¡"
    }
    explain = {
        "Buy": "ğŸ“ˆ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ØªØ´ÙŠØ± Ø¥Ù„Ù‰ Ø§ØªØ¬Ø§Ù‡ ØµØ§Ø¹Ø¯ â†’ Ø´Ø±Ø§Ø¡",
        "Strong Buy": "ğŸ“ˆ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø¨Ù‚ÙˆØ© Ù„ØµØ§Ù„Ø­ Ø§Ù„Ø´Ø±Ø§Ø¡",
        "Sell": "ğŸ“‰ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ØªØ´ÙŠØ± Ø¥Ù„Ù‰ Ù‡Ø¨ÙˆØ· â†’ Ø¨ÙŠØ¹",
        "Strong Sell": "ğŸ“‰ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø¨Ù‚ÙˆØ© Ù„ØµØ§Ù„Ø­ Ø§Ù„Ø¨ÙŠØ¹",
        "Neutral": "â³ Ø§Ù„Ø³ÙˆÙ‚ ØºÙŠØ± ÙˆØ§Ø¶Ø­ â†’ Ø§Ù†ØªØ¸Ø§Ø±"
    }

    now = datetime.now().strftime("%I:%M %p")
    e20 = indicators.get("EMA20", {"value": "?", "signal": "?"})
    e50 = indicators.get("EMA50", {"value": "?", "signal": "?"})
    rsi = indicators.get("RSI(14)", {"value": "?", "signal": "?"})
    boll = indicators.get("Bollinger Bands", {"value": "?", "signal": "?"})
    trend = indicators.get("Trend", {"value": "?", "signal": "?"})

    msg = f"""ğŸ“Š ØªÙˆØµÙŠØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù„Ø²ÙˆØ¬ EUR/USD:

ğŸ”¸ Ø§Ù„ØªÙˆØµÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: {signal} {emoji_map.get(signal, '')}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ˆ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©:
â€¢ EMA20 = {e20["value"]} â†’ {e20["signal"]}
{explain_indicator("EMA20", e20["value"], e20["signal"])}

â€¢ EMA50 = {e50["value"]} â†’ {e50["signal"]}
{explain_indicator("EMA50", e50["value"], e50["signal"])}

ğŸ“Š Ù…Ø¤Ø´Ø± Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ù†Ø³Ø¨ÙŠØ© (RSI 14):
â€¢ RSI = {rsi["value"]} â†’ {rsi["signal"]}
{explain_indicator("RSI(14)", rsi["value"], rsi["signal"])}

ğŸ“‰ Ù…Ø¤Ø´Ø± Ø¨ÙˆÙ„ÙŠÙ†Ø¬Ø± Ø¨Ø§Ù†Ø¯:
â€¢ Bollinger Bands = {boll["value"]} â†’ {boll["signal"]}
{explain_indicator("Bollinger Bands", boll["value"], boll["signal"])}

ğŸ“ˆ Ù…Ø¤Ø´Ø± Ø§Ù„Ø§ØªØ¬Ø§Ù‡ (Trend):
â€¢ Trend = {trend["value"]} â†’ {trend["signal"]}
{explain_trend(trend["signal"])}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ Ø®Ù„Ø§ØµØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„:
{explain.get(signal, 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙØ³ÙŠØ±.')}

ğŸ“… ØªÙˆÙ‚ÙŠØª Ø§Ù„ØªÙˆØµÙŠØ©: {now}
"""
    return msg

def send_recommendations():
    while True:
        signal = get_analysis()
        indicators = get_indicator_details()
        message = get_recommendation_message(signal, indicators)
        users = load_users()
        for uid, info in users.items():
            if info.get("subscribed"):
                try:
                    bot.send_message(int(uid), message)
                    if "Buy" in signal:
                        bot.send_message(int(uid), "ğŸš€ğŸŸ¢")
                    elif "Sell" in signal:
                        bot.send_message(int(uid), "ğŸ“‰ğŸ”´")
                    else:
                        bot.send_message(int(uid), "â³ğŸŸ¡")
                except Exception as e:
                    print("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:", e)
        time.sleep(60)

# ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠØ§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
import threading
threading.Thread(target=send_recommendations).start()
